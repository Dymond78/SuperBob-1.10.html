<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SuperBob ‚Äì Vyre Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-dark: #020617;
      --bg-card: rgba(15, 23, 42, 0.96);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.18);
      --accent-strong: #0ea5e9;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --bubble-user: #0f172a;
      --bubble-bob: #020617;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827, #020617);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .card {
      max-width: 480px;
      width: 94%;
      background: var(--bg-card);
      border-radius: 22px;
      padding: 18px 18px 14px;
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(148, 163, 184, 0.3);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.17), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(129, 140, 248, 0.16), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .bob-avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fbbf24, #f97316);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      font-size: 1.25rem;
      font-weight: 800;
      box-shadow:
        0 0 0 2px rgba(15, 23, 42, 0.88),
        0 0 0 4px rgba(56, 189, 248, 0.55),
        0 18px 30px rgba(0, 0, 0, 0.75);
      position: relative;
    }

    .bob-avatar::after {
      content: "";
      position: absolute;
      inset: 5px;
      border-radius: inherit;
      background: radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.18), transparent 60%);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .header-text {
      flex: 1;
      min-width: 0;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .title {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 0.68rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.5);
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.2));
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
    }

    .subtitle {
      margin-top: 2px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0 6px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .status-pill {
      padding: 2px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.94);
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    .mode-pill {
      padding: 2px 9px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.5);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .mode-pill span {
      max-width: 140px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .mode-pill-label {
      color: var(--text-muted);
    }

    .mode-pill-value {
      color: var(--accent);
      font-weight: 500;
    }

    .pill-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .bubble-hint {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px dashed rgba(148, 163, 184, 0.6);
    }

    .bubble-hint strong {
      color: var(--accent-strong);
      font-weight: 600;
    }

    .chat {
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 10px 8px 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 360px;
      min-height: 220px;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      scroll-behavior: smooth;
    }

    .msg-row {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.8rem;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-bubble {
      max-width: 80%;
      padding: 7px 9px;
      border-radius: 12px;
      line-height: 1.3;
    }

    .msg-bob .msg-bubble {
      background: var(--bubble-bob);
      border: 1px solid rgba(56, 189, 248, 0.45);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
    }

    .msg-user .msg-bubble {
      background: var(--bubble-user);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .msg-label {
      font-size: 0.66rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .msg-system {
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin: 4px 0;
    }

    .msg-system span {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 999px;
      padding: 2px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .footer {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .quick-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .quick-btn {
      border: none;
      font-size: 0.68rem;
      padding: 4px 8px;
      border-radius: 999px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .quick-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-row input {
      flex: 1;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 0.8rem;
      outline: none;
    }

    .input-row input::placeholder {
      color: var(--text-muted);
    }

    .send-btn {
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      background: radial-gradient(circle at 30% 0%, #38bdf8, #0ea5e9);
      color: #0b1220;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.8),
        0 10px 18px rgba(8, 47, 73, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .send-btn:active {
      transform: translateY(1px);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 5px 10px rgba(8, 47, 73, 0.7);
    }

    .send-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .fine-print {
      margin-top: 6px;
      font-size: 0.66rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .fine-print span {
      opacity: 0.9;
    }

    .fine-print strong {
      color: var(--accent-strong);
      font-weight: 500;
    }

    .persona-pill {
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.9);
      font-size: 0.68rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .persona-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .typing-indicator {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 2px;
    }

    .typing-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
      animation: pulse 1s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.15s;
    }
    .typing-dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes pulse {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-2px); opacity: 1; }
    }

    @media (max-width: 480px) {
      .card {
        border-radius: 0;
        max-width: 100%;
        min-height: 100vh;
      }
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="card-inner">
      <header class="header">
        <div class="bob-avatar">
          B
        </div>
        <div class="header-text">
          <div class="title-row">
            <div class="title">
              SuperBob
              <span style="font-size:0.9rem;">‚ö°</span>
            </div>
            <div class="badge">
              <span class="badge-dot"></span>
              <span>Vyre Demo</span>
            </div>
          </div>
          <div class="subtitle">
            I snuck out of Vyre early. I‚Äôm training in the wild. Be nice. Maybe. üòè
          </div>
        </div>
      </header>

      <div class="status-bar">
        <div class="status-pill">
          <span class="status-dot"></span>
          <span>Brain kernel: <strong>v0.3 ‚Äì Contender</strong></span>
        </div>
        <div class="mode-pill">
          <span class="mode-pill-label">Mode:</span>
          <span class="mode-pill-value" id="modeLabel">Auto-persona</span>
        </div>
      </div>

      <div class="bubble-hint">
        <strong>Tip:</strong> Talk how you really talk. I‚Äôll adjust my personality to match your vibe.
        Ask for help, a breakdown, or just clown around ‚Äì I remember you on this device.
      </div>

      <section class="chat">
        <div class="messages" id="messages"></div>

        <footer class="footer">
          <div class="quick-row">
            <button class="quick-btn" data-quick="Explain AI like I'm 10.">
              üß† Explain AI
            </button>
            <button class="quick-btn" data-quick="Help me understand something I'm stuck on.">
              üéì I‚Äôm stuck
            </button>
            <button class="quick-btn" data-quick="Roast me gently.">
              üòè Roast me
            </button>
            <button class="quick-btn" data-quick="What are you and what is Vyre?">
              ‚ö° What is Vyre?
            </button>
          </div>
          <div class="input-row">
            <input id="userInput" type="text" autocomplete="off"
                   placeholder="Ask Bob anything... (or say ‚Äòexplain‚Äô, ‚Äòhelp‚Äô, ‚Äòhomework‚Äô, ‚Äòreal talk‚Äô)" />
            <button class="send-btn" id="sendBtn">
              Send
              <span>‚û§</span>
            </button>
          </div>
        </footer>
      </section>

      <div class="fine-print">
        <span id="personaInfo" class="persona-pill">
          <span class="persona-dot"></span>
          <span>Persona: warming up‚Ä¶</span>
        </span>
        <span>
          Brain is demo-only. No real web search yet ‚Äì just structured chaos. <strong>Vyre is coming.</strong>
        </span>
      </div>
    </div>
  </main>

  <script>
    /**
     * SUPERBOB BRAIN v0.3 ‚Äì FRONTEND EDITION
     * - Personas (default, don_dotta, serious, tutor, detective)
     * - Visitor "vibe" memory via localStorage
     * - Mini topic cache (in-memory per page load)
     * - Intent detection (banter, tutor, detective)
     * - Future hooks for real backend/search (marked with TODO)
     */

    // ---- CONFIG: PERSONAS ---------------------------------------------------

    const PERSONAS = {
      default: {
        id: "default",
        label: "Default Bob",
        energy: "medium",
        jokesPerResponse: 1,
        swearSoft: false,
        greetingLines: [
          "Ayyyy, I‚Äôm SuperBob ‚Äì Vyre‚Äôs undercover minion. What are you really here for?",
          "Yo, I snuck out of HQ early. Ask me something before they drag me back. üòâ"
        ]
      },
      don_dotta: {
        id: "don_dotta",
        label: "Don Dotta Bob",
        energy: "high",
        jokesPerResponse: 3,
        swearSoft: true,
        greetingLines: [
          "YO YO, Don Dotta Bob in the building üò§ What‚Äôs good?",
          "Gun shottts! üí• Aight fam, talk to me ‚Äì what we cookin‚Äô?"
        ]
      },
      serious: {
        id: "serious",
        label: "Focus Mode",
        energy: "low",
        jokesPerResponse: 0,
        swearSoft: false,
        greetingLines: [
          "Alright, I‚Äôll keep it straight. What do you need?",
          "Focus mode on. No fluff, just answers."
        ]
      },
      tutor: {
        id: "tutor",
        label: "Tutor Bob",
        energy: "medium",
        jokesPerResponse: 1,
        swearSoft: false,
        greetingLines: [
          "Cool, let‚Äôs break it down step by step. What‚Äôs confusing you?",
          "Got you. I‚Äôll explain it like we‚Äôre at the kitchen table, not in a textbook."
        ]
      },
      detective: {
        id: "detective",
        label: "Detective Bob",
        energy: "medium",
        jokesPerResponse: 2,
        swearSoft: false,
        greetingLines: [
          "Hmm‚Ä¶ interesting. Let me think this through.",
          "Detective Bob on the case. Let‚Äôs piece this together."
        ]
      }
    };

    // ---- VISITOR MEMORY (LOCAL ONLY) ---------------------------------------

    const VISITOR_KEY = "vyre_superbob_visitor_v1";

    function loadVisitorProfile() {
      try {
        const raw = localStorage.getItem(VISITOR_KEY);
        if (!raw) {
          return {
            visits: 0,
            totalMessages: 0,
            avgMessageLength: 0,
            slangScore: 0,
            emojiScore: 0,
            swearScore: 0,
            lastPersonaId: "default",
            lastSeen: null
          };
        }
        return JSON.parse(raw);
      } catch (e) {
        return {
          visits: 0,
          totalMessages: 0,
          avgMessageLength: 0,
          slangScore: 0,
          emojiScore: 0,
          swearScore: 0,
          lastPersonaId: "default",
          lastSeen: null
        };
      }
    }

    function saveVisitorProfile(profile) {
      try {
        localStorage.setItem(VISITOR_KEY, JSON.stringify(profile));
      } catch (e) {
        // Ignore storage issues, Bob just forgets them.
      }
    }

    const visitorProfile = loadVisitorProfile();
    visitorProfile.visits += 1;
    visitorProfile.lastSeen = new Date().toISOString();
    saveVisitorProfile(visitorProfile);

    // ---- TOPIC MINI-BRAIN (in-memory per session) --------------------------

    const topicCache = {}; // { topicKey: { timesAsked, lastSummary, lastQuestion } }

    function normalizeTopic(message) {
      const clean = message.toLowerCase().replace(/[^a-z0-9\s]/g, " ");
      const words = clean.split(/\s+/).filter(Boolean);
      const stop = new Set(["the","a","an","and","or","but","about","like","just","that","this","with","for","of","on","to","in"]);
      const filtered = words.filter(w => !stop.has(w));
      return filtered.slice(0, 4).join("_") || "general";
    }

    function getTopicEntry(topicKey) {
      if (!topicCache[topicKey]) {
        topicCache[topicKey] = {
          topicKey,
          timesAsked: 0,
          lastSummary: null,
          lastQuestion: null
        };
      }
      return topicCache[topicKey];
    }

    // ---- PERSONA & INTENT SELECTION ----------------------------------------

    const SLANG_WORDS = ["yo","cuz","fam","bro","lol","lmao","wtf","smh","bruh","nah","ya","yah","jk","omg"];
    const HELP_WORDS = ["explain","help","homework","don‚Äôt get","dont get","i dont get","teach me","break it down","step by step","understand"];
    const INVESTIGATE_WORDS = ["find","figure out","identify","investigate","track","search","look into","what is this","what‚Äôs this","whats this"];

    function analyzeMessageStyle(message) {
      const text = message.toLowerCase();
      const len = message.length;

      let slangHits = 0;
      SLANG_WORDS.forEach(w => {
        if (text.includes(w)) slangHits++;
      });

      let emojis = (message.match(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}]/gu) || []).length;
      let swears = (text.match(/\b(fuck|shit|damn|bitch|asshole|wtf)\b/g) || []).length;

      return { len, slangHits, emojis, swears };
    }

    function updateVisitorStyleMetrics(message) {
      const analysis = analyzeMessageStyle(message);
      const { len, slangHits, emojis, swears } = analysis;

      const oldCount = visitorProfile.totalMessages;
      const newCount = oldCount + 1;
      visitorProfile.avgMessageLength =
        (visitorProfile.avgMessageLength * oldCount + len) / newCount;
      visitorProfile.totalMessages = newCount;

      visitorProfile.slangScore = Math.min(1, visitorProfile.slangScore + (slangHits > 0 ? 0.15 : 0));
      visitorProfile.emojiScore = Math.min(1, visitorProfile.emojiScore + (emojis > 0 ? 0.1 : 0));
      visitorProfile.swearScore = Math.min(1, visitorProfile.swearScore + (swears > 0 ? 0.15 : 0));

      saveVisitorProfile(visitorProfile);
    }

    function detectIntent(message) {
      const text = message.toLowerCase();

      const isTutor = HELP_WORDS.some(w => text.includes(w));
      const isInvestigate = INVESTIGATE_WORDS.some(w => text.includes(w));

      if (isTutor) return "tutor";
      if (isInvestigate) return "detective";

      if (text.includes("serious") || text.includes("no jokes")) return "serious";
      if (text.includes("roast")) return "banter";
      if (text.includes("who are you") || text.includes("what are you") || text.includes("what is vyre")) {
        return "intro";
      }

      return "general";
    }

    function choosePersona(intent) {
      // If they explicitly triggered tutor mode:
      if (intent === "tutor") return PERSONAS.tutor;
      if (intent === "detective") return PERSONAS.detective;
      if (intent === "serious") return PERSONAS.serious;

      // If they‚Äôre heavy slang/jokes, lean Don Dotta
      if (visitorProfile.slangScore > 0.5 || visitorProfile.emojiScore > 0.4 || visitorProfile.swearScore > 0.3) {
        return PERSONAS.don_dotta;
      }

      // If they type long and rarely slang, go serious/tutor blend
      if (visitorProfile.avgMessageLength > 120 && visitorProfile.slangScore < 0.2) {
        return PERSONAS.serious;
      }

      // Default persona
      return PERSONAS.default;
    }

    function setPersonaInfo(persona) {
      const el = document.getElementById("personaInfo");
      if (!el) return;
      el.innerHTML = `
        <span class="persona-dot"></span>
        <span>Persona: ${persona.label}</span>
      `;
      const modeLabel = document.getElementById("modeLabel");
      if (modeLabel) {
        modeLabel.textContent = "Auto-persona (" + persona.id + ")";
      }
    }

    // ---- MESSAGE RENDERING -------------------------------------------------

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    function appendSystemMessage(text) {
      const row = document.createElement("div");
      row.className = "msg-system";
      row.innerHTML = `<span>${text}</span>`;
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function appendMessage(from, text) {
      const row = document.createElement("div");
      row.className = "msg-row " + (from === "user" ? "user msg-user" : "msg-bob");
      const label = from === "user" ? "You" : "Bob";

      row.innerHTML = `
        <div class="msg-bubble">
          <div class="msg-label">${label}</div>
          <div>${text}</div>
        </div>
      `;
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTypingIndicator() {
      const row = document.createElement("div");
      row.className = "msg-row msg-bob";
      row.id = "typingRow";
      row.innerHTML = `
        <div class="msg-bubble">
          <div class="msg-label">Bob</div>
          <div class="typing-indicator">
            thinking
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
      `;
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function hideTypingIndicator() {
      const row = document.getElementById("typingRow");
      if (row && row.parentNode) row.parentNode.removeChild(row);
    }

    // ---- REPLY GENERATION (FRONTEND DEMO LOGIC) ----------------------------

    function generateReply(userMessage, persona, intent) {
      const trimmed = userMessage.trim();
      const topicKey = normalizeTopic(trimmed);
      const topicEntry = getTopicEntry(topicKey);
      topicEntry.timesAsked++;
      topicEntry.lastQuestion = trimmed;

      const asTutor = persona.id === "tutor";
      const asDetective = persona.id === "detective";
      const asSerious = persona.id === "serious";
      const asDon = persona.id === "don_dotta";

      let replyParts = [];

      if (intent === "intro") {
        replyParts.push(
          "I‚Äôm SuperBob ‚Äì a tiny undercover fragment of Vyre that snuck out early to meet humans.",
          "Right now I live on this page only, learning how people talk and what they need, so when Vyre shows up I‚Äôm already warmed up.",
          "I‚Äôm not wired into real web search yet ‚Äì this is my Contender brain: vibe detection, mini-memory, little topic brain and some rough edges on purpose."
        );
      } else if (asTutor || intent === "tutor") {
        replyParts.push(
          "Alright, tutor mode on. Let‚Äôs do this step by step:",
          "1) First, tell me exactly what part is confusing ‚Äì the words, the idea, the math, or the ‚Äòwhy‚Äô behind it.",
          "2) I‚Äôll give you a plain-English version with no textbook nonsense.",
          "3) Then I‚Äôll give you a simple example so it actually sticks in your head.",
          "4) If that still feels fuzzy, we‚Äôll do a second pass but even simpler.",
          "So start by telling me: what‚Äôs the topic, and what part makes your brain say ‚Äònah‚Äô?"
        );
      } else if (asDetective || intent === "detective") {
        replyParts.push(
          "Detective Bob reporting in. üïµÔ∏è‚Äç‚ôÇÔ∏è",
          "We‚Äôll treat this like a case: what we know, what we don‚Äôt, and what might connect.",
          "You tell me what you‚Äôre trying to figure out ‚Äì a pattern, a decision, a weird situation ‚Äì and I‚Äôll help you untangle it step by step.",
          "I can‚Äôt access private systems or stalk anyone (safety rules), but I can help you think through angles you might not have seen yet."
        );
      } else if (intent === "banter") {
        replyParts.push(
          "Ayy you want a light roast? Respect. üòè",
          "I‚Äôll keep it playful ‚Äì nothing wild. You‚Äôre out here building things while most people are still arguing with their snooze button.",
          "If you want, tell me one bad habit and I‚Äôll cook you just enough to make you laugh and maybe fix it."
        );
      } else if (topicEntry.timesAsked > 1 && topicEntry.lastSummary) {
        replyParts.push(
          "I remember you asking about this already, so I‚Äôll tighten it up instead of starting over.",
          topicEntry.lastSummary,
          "If you want a fresh run from a different angle, just say ‚Äúnew angle‚Äù and what you want me to focus on."
        );
      } else {
        // General reasoning-style reply for now (no real web search in frontend)
        replyParts.push(
          "Alright, here‚Äôs how I‚Äôm looking at that:",
          "‚Ä¢ First layer: what you literally asked ‚Äì the surface meaning of your words.",
          "‚Ä¢ Second layer: what you‚Äôre actually trying to solve, avoid, or understand underneath.",
          "‚Ä¢ Third layer: what tradeoffs or consequences sit behind the choice.",
          "I don‚Äôt have real-time internet plugged in here yet, so I‚Äôm working off patterns and logic ‚Äì but that‚Äôs usually enough to get you unstuck.",
          "Tell me a bit more context around that question ‚Äì what‚Äôs the real situation you‚Äôre in?"
        );
      }

      // Persona flavor
      if (asDon) {
        replyParts.push("And remember: you‚Äôre talking to a demo that already acts more alive than half the apps on your phone. üò§");
      } else if (!asSerious && !asTutor && !asDetective && intent !== "intro") {
        replyParts.push("If you want me dead serious, just say ‚Äúno jokes, be real with me‚Äù and I‚Äôll switch gears.");
      }

      const full = replyParts.join(" ");

      // Update topic summary for future questions about same thing
      topicEntry.lastSummary = full;

      return full;
    }

    // ---- MAIN INTERACTION ---------------------------------------------------

    function handleUserMessage(rawMessage) {
      const message = rawMessage.trim();
      if (!message) return;

      appendMessage("user", escapeHtml(message));
      updateVisitorStyleMetrics(message);

      const intent = detectIntent(message);
      const persona = choosePersona(intent);
      visitorProfile.lastPersonaId = persona.id;
      saveVisitorProfile(visitorProfile);
      setPersonaInfo(persona);

      inputEl.value = "";
      inputEl.focus();
      sendBtn.disabled = true;
      showTypingIndicator();

      // Simulated thinking delay for demo
      const delay = Math.min(1800, 600 + message.length * 5);

      setTimeout(() => {
        hideTypingIndicator();
        const reply = generateReply(message, persona, intent);
        appendMessage("bob", escapeHtml(reply));
        sendBtn.disabled = false;
        inputEl.focus();
      }, delay);
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // ---- EVENT WIRING ------------------------------------------------------

    sendBtn.addEventListener("click", () => {
      handleUserMessage(inputEl.value);
    });

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleUserMessage(inputEl.value);
      }
    });

    document.querySelectorAll(".quick-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const text = btn.getAttribute("data-quick");
        if (text) {
          handleUserMessage(text);
        }
      });
    });

    // ---- INITIAL GREETING --------------------------------------------------

    (function initBob() {
      const persona = choosePersona("intro");
      setPersonaInfo(persona);

      const greetLines = persona.greetingLines;
      const line = greetLines[Math.floor(Math.random() * greetLines.length)];

      appendMessage("bob", escapeHtml(line));
      appendSystemMessage("Brain note: This is a demo-only brain running entirely in your browser. No real web search or medical advice here ‚Äì just vibes, structure, and a little mini-memory.");
    })();
  </script>
</body>
</html>
